# BridgeLINE テスト設計書

## 📋 **文書情報**

| 項目 | 内容 |
|------|------|
| プロジェクト名 | BridgeLINE |
| 文書作成日 | 2025年8月 |
| 文書バージョン | 1.0 |
| 作成者 | 開発チーム |
| 最終更新日 | 2025年8月 |

---

## 🎯 **テスト概要**

### **プロジェクト概要**
BridgeLINEは、リアルタイム音声チャット機能を提供するWebアプリケーションです。WebSocketを使用したリアルタイム通信、音声セッション管理、ユーザー認証などの機能をテスト対象とします。

### **テスト対象システム**
- **バックエンドAPI**: FastAPIベースのRESTful API
- **WebSocket通信**: リアルタイムメッセージング
- **データベース**: PostgreSQL（音声セッション、ユーザー管理）
- **キャッシュ**: Redis（セッション管理、メッセージング）

### **技術スタック**
- **フレームワーク**: FastAPI 0.110.1
- **データベース**: PostgreSQL 15 + SQLAlchemy 2.0.29
- **キャッシュ**: Redis 5.0.3
- **認証**: Firebase Admin SDK 6.5.0
- **テスト**: pytest 8.1.1 + pytest-asyncio 0.23.6 + httpx 0.27.0
- **コンテナ**: Docker + Docker Compose
- **フロントエンドテスト**: Jest + Cypress

---

## 🏗️ **テスト戦略**

### **テストピラミッド**
```
    ┌─────────────┐
    │   E2E Test  │ ← 統合テスト（今後の拡張予定）
    └─────────────┘
    ┌─────────────┐
    │Integration  │ ← API統合テスト
    │   Tests     │
    └─────────────┘
    ┌─────────────┐
    │   Unit      │ ← ユニットテスト（スキーマ、モデル）
    │   Tests     │
    └─────────────┘
```

### **テストレベル**
1. **ユニットテスト**: 個別コンポーネントのテスト
2. **統合テスト**: APIエンドポイント間の連携テスト
3. **システムテスト**: 全体システムの動作テスト

### **テスト環境**
- **開発環境**: Docker Compose（推奨）
- **ローカル環境**: Python仮想環境
- **CI/CD環境**: GitHub Actions（今後の拡張予定）

---

## 📊 **テストカバレッジ**

### **実装済みテスト**

#### **1. WebSocket接続テスト**
| テストケース | 説明 | ステータス |
|-------------|------|-----------|
| `test_websocket_connection_success` | WebSocket接続の成功 | ✅ 実装済み |
| `test_websocket_authentication_failure` | 認証失敗時の処理 | ✅ 実装済み |
| `test_websocket_session_not_found` | セッション未発見時の処理 | ✅ 実装済み |
| `test_ping_pong_message` | Ping-Pongメッセージ処理 | ✅ 実装済み |
| `test_join_session_message` | セッション参加メッセージ処理 | ✅ 実装済み |
| `test_audio_data_message` | 音声データメッセージ処理 | ✅ 実装済み |
| `test_emoji_reaction_message` | 絵文字リアクションメッセージ処理 | ✅ 実装済み |

#### **2. 音声セッションAPIテスト**
| テストケース | 説明 | ステータス |
|-------------|------|-----------|
| `test_start_voice_session_success` | 音声セッション開始の成功 | ✅ 実装済み |
| `test_start_voice_session_validation_error` | バリデーションエラー | ✅ 実装済み |
| `test_get_voice_session_success` | 音声セッション取得の成功 | ✅ 実装済み |
| `test_get_voice_session_not_found` | 音声セッション未発見 | ✅ 実装済み |
| `test_update_voice_session_success` | 音声セッション更新の成功 | ✅ 実装済み |
| `test_delete_voice_session_success` | 音声セッション削除の成功 | ✅ 実装済み |

#### **3. スキーマテスト**
| テストケース | 説明 | ステータス |
|-------------|------|-----------|
| `VoiceSessionResponse` | モデル→スキーマ変換 | ✅ 実装済み |
| `VoiceSessionCreate` | 作成スキーマバリデーション | ✅ 実装済み |
| `WebSocketMessage` | WebSocketメッセージスキーマ | ✅ 実装済み |

### **今後の拡張予定**
- 🔄 **統合テスト**: エンドツーエンドテスト
- 🔄 **パフォーマンステスト**: 負荷テスト
- 🔄 **セキュリティテスト**: 認証・認可の詳細テスト
- 🔄 **UIテスト**: フロントエンドテスト

---

## 🧪 **テスト実装詳細**

### **1. テストファイル構成**
```
backend/tests/
├── conftest.py              # 共通フィクスチャ
├── test_websocket.py        # WebSocketテスト
├── test_voice_sessions.py   # 音声セッションAPIテスト
└── test_schemas.py          # スキーマテスト（今後の拡張）
```

### **2. テストフィクスチャ**

#### **共通フィクスチャ** (`conftest.py`)
```python
@pytest_asyncio.fixture
async def client() -> CombinedTestClient:
    """HTTP(Async) + WebSocket を兼ねるクライアント"""
    transport = ASGITransport(app=app)
    async_client = AsyncClient(transport=transport, base_url="http://test")
    ws_client = TestClient(app)
    combined = CombinedTestClient(async_client, ws_client)
    try:
        yield combined
    finally:
        await combined.aclose()

@pytest.fixture
def mock_user():
    """モックユーザー"""
    return User(
        id=1,
        email="test@example.com",
        username="testuser",
        display_name="Test User",
        is_active=True,
        created_at=datetime.now(),
        updated_at=datetime.now(),
    )

@pytest.fixture
def mock_voice_session():
    """モック音声セッション"""
    return VoiceSession(
        id=1,
        room_id="test_session_123",
        title="Test Session",
        description="Test session for WebSocket",
        status="active",
        host_id=1,
        team_id=None,
        duration_minutes=0.0,
        participant_count=0,
        recording_url=None,
        is_public=False,
        allow_recording=True,
        started_at=datetime.now(),
        ended_at=None,
        created_at=datetime.now(),
        updated_at=datetime.now(),
    )
```

### **3. WebSocketテスト実装**

#### **接続テスト**
```python
class TestWebSocketConnection:
    async def test_websocket_connection_success(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """WebSocket接続の成功をテスト"""
        with patch("app.core.auth.get_current_user_from_token", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.get_by_room_id", return_value=mock_voice_session):
            
            with client.websocket_connect(
                "/api/v1/ws/voice-sessions/test_session_123?token=test_token"
            ) as websocket:
                # 接続確立メッセージの受信を確認
                data = websocket.receive_json()
                assert data["type"] == "connection_established"
                assert data["session_id"] == "test_session_123"
                assert data["user_id"] == 1
```

#### **メッセージ処理テスト**
```python
class TestWebSocketMessageHandling:
    async def test_ping_pong_message(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """Ping-Pongメッセージのテスト"""
        with patch("app.core.auth.get_current_user_from_token", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.get_by_room_id", return_value=mock_voice_session):
            
            with client.websocket_connect(
                "/api/v1/ws/voice-sessions/test_session_123?token=test_token"
            ) as websocket:
                # Pingメッセージ送信
                websocket.send_json({"type": "ping"})
                
                # Pongレスポンスの受信確認
                response = websocket.receive_json()
                assert response["type"] == "pong"
```

### **4. APIテスト実装**

#### **音声セッションAPIテスト**
```python
class TestVoiceSessionControlAPI:
    async def test_start_voice_session_success(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """音声セッション開始の成功をテスト"""
        with patch("app.core.auth.get_current_user", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.create", return_value=mock_voice_session):
            
            response = await client.post(
                "/api/v1/voice-sessions/",
                json={
                    "title": "Test Session",
                    "description": "Test Description",
                    "is_public": False,
                    "allow_recording": True
                }
            )
            
            assert response.status_code == 201
            data = response.json()
            assert data["session_id"] == "test_session_123"
            assert data["user_id"] == 1
```

---

## 🚀 **テスト実行方法**

### **1. Docker環境での実行（推奨）**

#### **環境起動**
```bash
# 全サービス起動
make start

# ヘルスチェック
docker ps
```

#### **テスト実行**
```bash
# 全テスト実行
make test

# 特定のテストファイル実行
docker exec bridge_line_backend pytest tests/test_websocket.py -v

# 特定のテストケース実行
docker exec bridge_line_backend pytest tests/test_websocket.py::TestWebSocketConnection::test_websocket_connection_success -v
```

### **2. ローカル環境での実行**

#### **環境構築**
```bash
# Python 3.11以上が必要
python -m venv .venv311
.venv311\Scripts\Activate.ps1

# 依存関係インストール
pip install -r backend/requirements.txt
pip install -r backend/requirements-dev.txt
```

#### **テスト実行**
```bash
# 全テスト実行
pytest backend/tests/

# 特定のテストファイル実行
pytest backend/tests/test_websocket.py -v
```

### **3. テスト結果の確認**

#### **成功例**
```bash
============================= test session starts =============================
platform linux -- Python 3.11.9, pytest-7.4.3, pluggy-1.3.0
rootdir: /app
plugins: asyncio-0.21.1, cov-4.1.0, hypothesis-6.75.3, reportlog-0.3.0, timeout-2.1.0, xdist-3.3.1
collected 47 items

tests/test_websocket.py::TestWebSocketConnection::test_websocket_connection_success PASSED
tests/test_websocket.py::TestWebSocketConnection::test_websocket_authentication_failure PASSED
tests/test_websocket.py::TestWebSocketMessageHandling::test_ping_pong_message PASSED
# ... その他のテスト

============================== 47 passed, 0 failed ==============================
```

---

## 🔧 **テスト環境設定**

### **1. 必要なファイル**

#### **.gitignore**
```gitignore
# 仮想環境
.venv*/
venv*/

# Python
__pycache__/
*.py[cod]
*.so

# テスト結果
.pytest_cache/
.coverage
```

#### **requirements-dev.txt**
```
fastapi==0.104.1
uvicorn==0.24.0
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.2
```

#### **pytest.ini**
```ini
[tool:pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

### **2. Docker設定**

#### **compose.yaml**
```yaml
services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/bridgeline
      - REDIS_URL=redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

#### **Makefile**
```makefile
.PHONY: start stop test build

start:
	docker-compose up -d

stop:
	docker-compose down

test:
	docker exec bridge_line_backend pytest -v

build:
	docker-compose build
```

---

## 🐛 **トラブルシューティング**

### **よくある問題と対処法**

#### **1. SQLAlchemy関係性エラー**
```bash
# エラー例
sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize

# 対処法
# モデルに不足しているrelationshipを追加
class User(Base):
    created_chat_rooms = relationship("ChatRoom", back_populates="creator")
    chat_messages = relationship("ChatMessage", back_populates="sender")
```

#### **2. Pydanticバリデーションエラー**
```bash
# エラー例
ValidationError: 1 validation error for VoiceSessionResponse

# 対処法
# スキーマのフィールド名をモデルと一致させる
class VoiceSessionResponse(VoiceSessionBase, TimestampMixin):
    room_id: str = Field(..., alias="session_id")
    host_id: int = Field(..., alias="user_id")
```

#### **3. WebSocket接続エラー（404）**
```bash
# エラー例
HTTPException: 404 Not Found

# 対処法
# APIルーターのパス設定を確認
router.include_router(websocket_router, prefix="/ws", tags=["websocket"])
```

#### **4. 認証エラー（403）**
```bash
# エラー例
HTTPException: 403 Forbidden

# 対処法
# テストでの認証モックを確認
with patch("app.core.auth.get_current_user", return_value=mock_user):
```

### **デバッグ方法**

#### **ログ確認**
```bash
# バックエンドログ
docker logs bridge_line_backend

# リアルタイムログ
docker logs -f bridge_line_backend
```

#### **コンテナ状態確認**
```bash
# コンテナ一覧
docker ps

# コンテナ内でコマンド実行
docker exec -it bridge_line_backend bash
```

#### **テスト実行時の詳細出力**
```bash
# 詳細出力
pytest -v -s

# 特定のテストのみ実行
pytest tests/test_websocket.py::TestWebSocketConnection::test_websocket_connection_success -v -s
```

---

## 📈 **テストメトリクス**

### **現在のテスト状況**
- **総テスト数**: 47個
- **成功**: 47個
- **失敗**: 0個
- **スキップ**: 0個
- **カバレッジ**: 約85%（推定）

### **テスト実行時間**
- **全テスト実行**: 約30秒
- **WebSocketテスト**: 約10秒
- **APIテスト**: 約15秒
- **スキーマテスト**: 約5秒

### **今後の改善目標**
- **テストカバレッジ**: 90%以上
- **実行時間**: 20秒以内
- **統合テスト**: 10個以上
- **パフォーマンステスト**: 実装予定

---

## 📝 **テストケース管理**

### **テストケーステンプレート**

#### **新機能追加時のテストケース作成**
```markdown
## テストケース: [機能名]

### 前提条件
- [ ] 必要なデータが準備されている
- [ ] 認証が完了している
- [ ] 関連サービスが起動している

### テストケース
| No | テストケース名 | 入力 | 期待結果 | ステータス |
|----|---------------|------|----------|-----------|
| 1 | 正常系テスト | 正常な入力 | 成功レスポンス | ✅ |
| 2 | 異常系テスト | 不正な入力 | エラーレスポンス | ✅ |
| 3 | 境界値テスト | 境界値 | 適切な処理 | ✅ |

### 実装コード
```python
async def test_[機能名]_success(self, client, mock_data):
    # テスト実装
    pass
```
```

### **テストケースレビュー**
- [ ] テストケースが要件を網羅している
- [ ] エッジケースが考慮されている
- [ ] テストデータが適切に準備されている
- [ ] モックが適切に設定されている

---

## 🔄 **継続的改善**

### **定期的なレビュー項目**
- [ ] テストカバレッジの確認
- [ ] テスト実行時間の最適化
- [ ] 新機能に対するテストの追加
- [ ] テスト環境の更新

### **今後の拡張予定**
1. **統合テストの実装**
2. **パフォーマンステストの追加**
3. **セキュリティテストの強化**
4. **UIテストの実装**
5. **CI/CDパイプラインの構築**

---

## 📞 **サポート・連絡先**

### **問題報告時の情報**
- エラーメッセージの詳細
- 実行環境（OS、Pythonバージョン、Dockerバージョン）
- 実行したコマンド
- ログファイルの内容

### **チーム内での共有**
- テスト結果の定期共有
- 新機能追加時のテスト設計レビュー
- テスト環境の統一管理

---

## 📚 **参考資料**

### **技術ドキュメント**
- [FastAPI Testing](https://fastapi.tiangolo.com/tutorial/testing/)
- [pytest Documentation](https://docs.pytest.org/)
- [WebSocket Testing](https://websockets.readthedocs.io/en/stable/)

### **プロジェクト固有ドキュメント**
- `backend/README.md` - バックエンド開発ガイド
- `compose.yaml` - Docker環境設定
- `Makefile` - 開発コマンド集約

---

**文書バージョン**: 1.0  
**最終更新**: 2024年12月  
**次回レビュー予定**: 2025年1月

# 認証機能仕様書

## 概要

本プロジェクトは、Firebase AuthenticationとJWT（JSON Web Token）を組み合わせたハイブリッド認証システムを採用しています。管理者によるユーザー作成、仮パスワード管理、WebSocket認証など、企業向けのセキュアな認証機能を提供します。

## 認証アーキテクチャ

### 認証フロー概要

```mermaid
graph TB
    A[ユーザー] --> B[フロントエンド]
    B --> C[Firebase Authentication]
    C --> D[バックエンドAPI]
    D --> E[JWT Token生成]
    E --> F[データベース認証]
    
    G[管理者] --> H[管理者ダッシュボード]
    H --> I[ユーザー作成]
    I --> J[Firebase User作成]
    J --> K[PostgreSQL User作成]
    
    L[WebSocket接続] --> M[Firebase ID Token検証]
    M --> N[データベース認証]
    N --> O[WebSocket接続確立]
```

## 認証方式

### 1. Firebase Authentication
- **目的**: フロントエンドでのユーザー認証
- **認証方式**: メール/パスワード認証
- **トークン**: Firebase ID Token
- **有効期限**: 1時間（Firebase標準）

### 2. JWT認証
- **目的**: バックエンドAPI認証
- **認証方式**: Bearer Token
- **有効期限**: 30分
- **ペイロード**: ユーザーID、メールアドレス、Firebase UID

### 3. WebSocket認証
- **目的**: リアルタイム通信の認証
- **認証方式**: Firebase ID Token（クエリパラメータ）
- **タイムアウト**: 10秒

## ユーザー管理

### ユーザーモデル（User）

```python
class User(Base):
    # 基本情報
    id: int
    email: str
    username: str
    full_name: str
    firebase_uid: str
    
    # 認証関連
    hashed_password: str  # Firebase認証の場合はnull
    has_temporary_password: bool
    temporary_password_expires_at: datetime
    is_first_login: bool
    last_password_change_at: datetime
    
    # アカウント状態
    is_active: bool
    is_verified: bool
    is_admin: bool
    
    # プロフィール情報
    department: str
    nickname: str
    # ... その他のプロフィール項目
```

### ユーザー作成フロー

1. **管理者によるユーザー作成**
   - 管理者がダッシュボードでユーザー情報を入力
   - Firebase Authでユーザー自動作成（仮パスワード設定）
   - PostgreSQLにユーザー情報を保存
   - 仮パスワードを管理者に通知

2. **初回ログイン**
   - ユーザーが仮パスワードでログイン
   - パスワード変更画面にリダイレクト
   - 新しいパスワードを設定
   - 通常のダッシュボードにアクセス可能

## API エンドポイント

### 認証関連API

#### 1. Firebase認証ログイン
```
POST /api/v1/auth/firebase-login
```

**リクエスト:**
```json
{
  "id_token": "firebase_id_token",
  "display_name": "ユーザー名"
}
```

**レスポンス:**
```json
{
  "access_token": "jwt_token",
  "token_type": "bearer",
  "expires_in": 1800,
  "has_temporary_password": false,
  "needs_password_setup": false,
  "user": {
    "id": 1,
    "email": "user@example.com",
    "display_name": "ユーザー名",
    "firebase_uid": "firebase_uid",
    "is_active": true,
    "is_admin": false
  }
}
```

#### 2. 仮パスワードログイン
```
POST /api/v1/auth/temporary-login
```

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "temporary_password"
}
```

#### 3. パスワード変更
```
POST /api/v1/auth/change-password
```

**リクエスト:**
```json
{
  "current_password": "current_password",
  "new_password": "new_password"
}
```

#### 4. トークン更新
```
POST /api/v1/auth/refresh
```

#### 5. ログイン状態確認
```
GET /api/v1/auth/login-status
```

**レスポンス:**
```json
{
  "is_first_login": false,
  "has_temporary_password": false,
  "needs_password_setup": false
}
```

#### 6. 現在のユーザー情報取得
```
GET /api/v1/auth/me
```

### 管理者認証API

#### 1. 管理者権限チェック
```
GET /api/v1/admin-role/check-admin
```

**レスポンス:**
```json
{
  "status": "success",
  "message": "管理者権限が確認されました",
  "user": {
    "id": 1,
    "email": "admin@example.com",
    "firebase_uid": "firebase_uid",
    "is_admin": true
  }
}
```

#### 2. 開発環境用管理者作成
```
POST /api/v1/auth/dev/create-admin
```

**リクエスト:**
```json
{
  "email": "admin@example.com",
  "name": "管理者名",
  "department": "部署名",
  "role": "admin"
}
```

## フロントエンド認証

### 認証プロバイダー（AuthProvider）

```typescript
interface AuthContextType {
  user: FirebaseUser | null
  backendToken: string | null
  isLoading: boolean
  login: (email: string, password: string) => Promise<void>
  temporaryLogin: (email: string, password: string) => Promise<void>
  logout: () => Promise<void>
  adminLogin: (email: string, password: string) => Promise<string | null>
}
```

### 認証フロー

1. **通常ログイン**
   ```typescript
   // Firebase認証
   const firebaseUser = await signInWithEmailAndPassword(auth, email, password)
   
   // バックエンド認証
   const idToken = await firebaseUser.getIdToken()
   const response = await fetch('/api/v1/auth/firebase-login', {
     method: 'POST',
     body: JSON.stringify({ id_token: idToken })
   })
   
   // JWTトークンを保存
   const { access_token } = await response.json()
   localStorage.setItem('jwt_token', access_token)
   ```

2. **仮パスワードログイン**
   ```typescript
   // 仮パスワードでFirebase認証
   await signInWithEmailAndPassword(auth, email, temporaryPassword)
   
   // バックエンドで仮パスワード認証
   const response = await fetch('/api/v1/auth/temporary-login', {
     method: 'POST',
     body: JSON.stringify({ email, password: temporaryPassword })
   })
   ```

### 保護されたルート

```typescript
// 管理者専用ページ
<ProtectedRoute requiredRole="admin">
  <AdminDashboard />
</ProtectedRoute>

// チームメンバー専用ページ
<ProtectedRoute requiredRole="team_member">
  <TeamDashboard />
</ProtectedRoute>
```

## WebSocket認証

### 認証フロー

1. **接続時認証**
   ```typescript
   // Firebase IDトークンを取得
   const idToken = await getIdToken()
   
   // WebSocket接続（トークンをクエリパラメータに含める）
   const ws = new WebSocket(`ws://localhost:8000/ws/voice-sessions/${sessionId}?token=${idToken}`)
   ```

2. **サーバー側認証**
   ```python
   async def authenticate_websocket(websocket: WebSocket) -> User:
       # クエリパラメータからトークンを取得
       token = websocket.query_params.get("token")
       
       # Firebase IDトークンを検証
       firebase_payload = await verify_firebase_token(token)
       
       # データベースでユーザーを検索
       user = await get_user_by_firebase_uid(firebase_payload["uid"])
       
       return user
   ```

### 認証タイムアウト

- **認証タイムアウト**: 10秒
- **接続タイムアウト**: 30秒
- **再試行**: 最大3回

## セキュリティ機能

### 1. パスワード管理

- **仮パスワード**: 管理者が作成時に設定
- **有効期限**: 7日間
- **初回ログイン**: パスワード変更必須
- **ハッシュ化**: bcrypt（パスワード認証の場合）

### 2. トークン管理

- **JWT有効期限**: 30分
- **リフレッシュ**: 自動更新機能
- **無効化**: ログアウト時にクライアント側で削除

### 3. セッション管理

- **セッションタイムアウト**: 5分（管理者画面）
- **アクティビティ監視**: ユーザー操作を監視
- **自動ログアウト**: 非アクティブ時に実行

### 4. 権限管理

- **管理者権限**: `is_admin`フラグで制御
- **アクティブユーザー**: `is_active`フラグで制御
- **認証済みユーザー**: `is_verified`フラグで制御

## エラーハンドリング

### 認証エラー

| エラーコード | 説明 | 対処法 |
|-------------|------|--------|
| 401 | 認証失敗 | ログイン画面にリダイレクト |
| 403 | 権限不足 | 適切な権限を持つアカウントでログイン |
| 400 | 仮パスワード期限切れ | 管理者に連絡してパスワード再発行 |
| 500 | サーバーエラー | システム管理者に連絡 |

### ログ出力

```python
# 認証成功
logger.info(f"User authenticated successfully: {email}")

# 認証失敗
logger.warning(f"Authentication failed for {email}: {error}")

# 管理者権限チェック
logger.info(f"Admin check requested: user_id={user_id}")
```

## 設定

### 環境変数

```bash
# Firebase設定
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id

# JWT設定
JWT_SECRET_KEY=your_secret_key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30

# データベース設定
DATABASE_URL=postgresql://user:password@localhost/dbname
```

### Firebase設定

```json
{
  "apiKey": "your_api_key",
  "authDomain": "your_domain",
  "projectId": "your_project_id",
  "storageBucket": "your_storage_bucket",
  "messagingSenderId": "your_sender_id",
  "appId": "your_app_id"
}
```

## テスト

### 認証テスト

```python
# テスト用認証
async def test_authentication():
    # 仮パスワードログイン
    response = await client.post("/api/v1/auth/temporary-login", json={
        "email": "test@example.com",
        "password": "temporary_password"
    })
    assert response.status_code == 200
    
    # JWTトークン取得
    token = response.json()["access_token"]
    
    # 認証が必要なエンドポイントにアクセス
    headers = {"Authorization": f"Bearer {token}"}
    response = await client.get("/api/v1/auth/me", headers=headers)
    assert response.status_code == 200
```

### WebSocket認証テスト

```python
# WebSocket認証テスト
async def test_websocket_auth():
    # 認証トークンを取得
    token = await get_test_token()
    
    # WebSocket接続
    async with websockets.connect(f"ws://localhost:8000/ws/voice-sessions/1?token={token}") as websocket:
        # 接続成功を確認
        assert websocket.open
```

## 運用・監視

### ログ監視

- **認証成功/失敗**: 構造化ログで出力
- **管理者操作**: 詳細ログで記録
- **WebSocket接続**: 接続数とエラー率を監視

### パフォーマンス監視

- **認証レスポンス時間**: 平均500ms以下
- **WebSocket認証時間**: 平均200ms以下
- **データベース接続**: 接続プールで最適化

### セキュリティ監視

- **不正ログイン試行**: レート制限で防止
- **トークン漏洩**: 定期的なトークンローテーション
- **管理者権限**: 定期的な権限確認

## 今後の拡張予定

### 1. 多要素認証（MFA）
- SMS認証
- TOTP認証
- 生体認証

### 2. SSO連携
- SAML認証
- OAuth2.0連携
- Active Directory連携

### 3. 高度なセキュリティ
- デバイス管理
- 地理的制限
- 異常検知

## まとめ

本プロジェクトの認証システムは、Firebase AuthenticationとJWTを組み合わせた堅牢な認証基盤を提供しています。管理者によるユーザー管理、仮パスワードシステム、WebSocket認証など、企業向けの要件を満たす包括的な認証機能を実装しています。

セキュリティ、パフォーマンス、運用性を考慮した設計により、安全で使いやすい認証システムを実現しています。

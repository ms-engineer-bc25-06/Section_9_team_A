# Bridge LINE - 開発ルール

## 1. ブランチ運用

### 1-1. ブランチ構成

- **メインブランチ**: `main`
    - 本番デプロイ用の最新統合ブランチ
    - 直接コミット禁止、Pull Request (PR)を通じてのみマージ
- **開発ブランチ**: `develop`
    - 開発用のメインブランチ
    - 各フィーチャーブランチの統合先

### 1-2. 作業ブランチ命名規則

- **機能開発ブランチ**: `feature/xxx_name` (例: `feature/login_asuka`)
    - 新しい機能を開発するためのブランチ
    - `develop`ブランチから派生
- **バグ修正ブランチ**: `bugfix/xxx_name` (例: `bugfix/login_asuka`)
    - バグ修正を行うためのブランチ
    - `develop`ブランチから派生
- **ドキュメントブランチ**: `doc/xxx_name` (例: `doc/readme_asuka`)
    - ドキュメント整備のためのブランチ
    - `develop`ブランチから派生

### 1-3. ブランチ作成・運用ルール

- 新しいタスクごとにブランチを作成
- ブランチは機能単位で作成し、小さく保つ
- 作業終了後は、PRを通じて`develop`へマージ
- マージ後はブランチを削除（残す場合はコメントで明記）

## 2. 開発フロー

### 2-1. 基本的な作業手順

1. `develop`ブランチから新しいフィーチャーブランチを作成
2. GitHub Issues で作業を管理（カンバン方式）
3. ブランチで開発を行い、小さな単位でコミット
4. 実装完了後、Pull Requestを作成
5. コードレビューを実施
6. レビュー承認後、`develop`ブランチへマージ
7. フィーチャーブランチを削除

### 2-2. 作業開始時コマンド例

```bash
git checkout develop
git pull origin develop
git checkout -b feature/your-feature-name
```

### 2-3. 作業完了時コマンド例

```bash
git add .
git commit -m "feat: 機能の説明"
git push origin feature/your-feature-name
```

## 3. Pull Request (PR) ルール

### 3-1. PR記載項目（PRテンプレート使用）

- **PRタイトル**: issue番号＋概要 (例: #1 環境構築_フロント)
- **やったこと**
- **確認したこと**
- **補足** (スクショなど)
- **メンバーへのメンション**: プルリクが出たことの周知

### 3-2. レビュールール

- 最低1人のレビュアーによる承認が必要
- PR対応可能な人が対応：プルリクコメントに👀を付ける
- 大きな変更は、細かくPRを分割する
- レビュー後の修正では再度承認を得る
- 修正がある場合はPRコメント機能でPR作成者に返す
- 修正後、再度同一ブランチでcommit, pushすると同一PRに自動的に追加

### 3-3. マージルール

- `main`および`develop`への直接マージは禁止、必ずPRを通す
- 細かくPRとマージを行い、コンフリクトを最小化
- コンフリクトはフィーチャーブランチ側で解決
- `develop`ブランチは常にデプロイ可能な状態を保つ
- マージ内容はチーム全員で共有

## 4. コミットメッセージ規則

### 4-1. フォーマット

```
[prefix] issue番号(#数字) 概要
(2行目以降: 必要に応じて詳細説明)
```

### 4-2. Prefix一覧

| Prefix | 用途 |
| --- | --- |
| `feat` | 新機能の追加 |
| `fix` | バグ修正 |
| `docs` | ドキュメントの追加・更新 |
| `style` | コードスタイルの修正（機能に影響なし） |
| `refactor` | リファクタリング |
| `test` | テストの追加・修正 |
| `chore` | ビルドプロセス・ツールの変更 |

### 4-3. コミットメッセージ例

```bash
feat: #15 AI分析ダッシュボードの実装
- Rechartsを使用したデータ可視化
- 個性分析、コミュニケーション分析の表示
- リアルタイム更新機能の追加

fix: #23 WebSocket接続の安定性向上
- 自動再接続ロジックの改善
- エラーハンドリングの強化

docs: #30 API設計書の更新
- 新規エンドポイントの追加
- レスポンス例の充実
```

## 5. コード品質・テスト

### 5-1. フロントエンド（Next.js + TypeScript）

#### **型チェック**
```bash
# 型チェックの実行
npm run type-check

# 特定ディレクトリの型チェック
npx tsc --noEmit --skipLibCheck src/components/analytics/*.tsx
```

#### **Linting・Formatting**
```bash
# ESLintによるコードチェック
npm run lint

# 自動修正
npm run lint:fix

# Prettierによるフォーマット
npm run format

# フォーマットチェック
npm run format:check
```

#### **テスト**
```bash
# 単体テスト実行
npm run test

# カバレッジ付きテスト
npm run test:coverage

# ウォッチモード
npm run test:watch

# CI用テスト
npm run test:ci
```

### 5-2. バックエンド（FastAPI + Python）

#### **型チェック**
```bash
# MyPyによる型チェック
mypy app/

# 特定ファイルの型チェック
mypy app/main.py
```

#### **Linting・Formatting**
```bash
# Blackによるフォーマット
black app/

# isortによるインポート整理
isort app/

# Flake8によるLinting
flake8 app/
```

#### **テスト**
```bash
# テスト実行
pytest

# カバレッジ付きテスト
pytest --cov=app

# 特定テストファイル
pytest tests/test_ai_analysis.py

# 並列実行
pytest -n auto
```

### 5-3. 品質チェック項目

#### **実装前チェック**
- [ ] 型定義の確認
- [ ] API仕様の確認
- [ ] データベース設計の確認
- [ ] セキュリティ要件の確認

#### **実装中チェック**
- [ ] 型エラーの解消
- [ ] Lintingエラーの解消
- [ ] テストの作成・実行
- [ ] ドキュメントの更新

#### **実装後チェック**
- [ ] 全テストの通過
- [ ] 型チェックの通過
- [ ] コードレビューの完了
- [ ] 動作確認の完了

## 6. 実装済み機能の確認方法

### 6-1. フロントエンド機能確認

#### **AI分析ダッシュボード**
```bash
# コンポーネントの存在確認
ls src/components/analytics/

# 型チェック
npx tsc --noEmit --skipLibCheck src/components/analytics/*.tsx

# テスト実行
npm test -- --testPathPattern=analytics
```

#### **WebSocket接続**
```bash
# フックの存在確認
ls src/hooks/useRealtimeAnalysis.ts

# 型チェック
npx tsc --noEmit --skipLibCheck src/hooks/useRealtimeAnalysis.ts
```

### 6-2. バックエンド機能確認

#### **AI分析サービス**
```bash
# サービスの存在確認
ls app/services/ai_analysis_service.py

# 型チェック
mypy app/services/ai_analysis_service.py

# テスト実行
pytest tests/test_ai_analysis_service.py
```

#### **WebSocket実装**
```bash
# WebSocketハンドラーの確認
ls app/core/websocket.py

# 型チェック
mypy app/core/websocket.py
```

### 6-3. データベース確認

#### **テーブル構造**
```bash
# マイグレーションファイルの確認
ls backend/alembic/versions/

# 最新マイグレーションの確認
cd backend
alembic current
alembic history
```

#### **データベース接続**
```bash
# 接続テスト
cd backend
python -c "from app.core.database import test_database_connection; import asyncio; print(asyncio.run(test_database_connection()))"
```

## 7. デプロイメント・運用

### 7-1. 環境別デプロイ

#### **開発環境**
```bash
# Docker環境の起動
make start

# ログの確認
make logs

# 環境の停止
make stop
```

#### **ステージング環境**
```bash
# Railwayへのデプロイ
railway up

# 環境変数の確認
railway variables
```

#### **本番環境**
```bash
# 本番デプロイ（手動）
git checkout main
git merge develop
git push origin main

# Railway本番環境へのデプロイ
railway up --environment production
```

### 7-2. 監視・ログ

#### **ログ確認**
```bash
# バックエンドログ
make backend

# フロントエンドログ
cd frontend && npm run dev

# データベースログ
docker logs bridge_line_postgres
```

#### **ヘルスチェック**
```bash
# APIヘルスチェック
curl http://localhost:8000/health

# フロントエンドビルド確認
cd frontend && npm run build
```

## 8. トラブルシューティング

### 8-1. よくある問題と解決方法

#### **型エラーの解決**
```bash
# フロントエンド
npm run type-check

# バックエンド
mypy app/
```

#### **依存関係の問題**
```bash
# フロントエンド
rm -rf node_modules package-lock.json
npm install

# バックエンド
pip install -r requirements.txt --upgrade
```

#### **データベース接続問題**
```bash
# 接続確認
cd backend
python -c "from app.core.database import test_database_connection; import asyncio; print(asyncio.run(test_database_connection()))"

# マイグレーション確認
alembic current
alembic upgrade head
```

### 8-2. デバッグ方法

#### **フロントエンドデバッグ**
```bash
# 開発者ツールの確認
# ブラウザのコンソールログ
# React Developer Tools
# Network タブでのAPI通信確認
```

#### **バックエンドデバッグ**
```bash
# ログレベルの変更
export LOG_LEVEL=DEBUG

# 特定エンドポイントのテスト
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"firebase_token": "test"}'
```

## 9. セキュリティ・プライバシー

### 9-1. セキュリティチェック項目

- [ ] 環境変数の適切な管理
- [ ] API認証・認可の実装
- [ ] 入力値のバリデーション
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策

### 9-2. プライバシー保護

- [ ] 個人情報の暗号化
- [ ] データアクセス制御
- [ ] 監査ログの記録
- [ ] データ保持期間の管理

## 10. パフォーマンス・最適化

### 10-1. パフォーマンスチェック項目

- [ ] データベースクエリの最適化
- [ ] フロントエンドのバンドルサイズ
- [ ] APIレスポンス時間
- [ ] メモリ使用量の最適化

### 10-2. 最適化手法

#### **フロントエンド**
```bash
# バンドルサイズの確認
npm run build
# 出力されるバンドルサイズを確認

# 不要な依存関係の確認
npm audit
npm outdated
```

#### **バックエンド**
```bash
# パフォーマンステスト
pytest tests/test_performance.py

# プロファイリング
python -m cProfile -o profile.stats app/main.py
```

---

## **開発ルールの遵守確認**

### **毎日の開発開始時**
- [ ] `develop`ブランチの最新化
- [ ] 既存のIssue・PRの確認
- [ ] 今日の作業内容の明確化

### **機能実装完了時**
- [ ] テストの作成・実行
- [ ] 型チェックの通過
- [ ] Lintingエラーの解消
- [ ] ドキュメントの更新
- [ ] PRの作成

### **PRマージ後**
- [ ] ブランチの削除
- [ ] 次の作業の開始
- [ ] チームメンバーへの共有

この開発ルールに従うことで、高品質なコードと効率的な開発プロセスを維持できます。
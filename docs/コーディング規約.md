# Bridge LINE - コーディング規約

## 概要

このドキュメントは、Bridge LINEプロジェクトにおけるコーディング規約を定義します。フロントエンド（Next.js + TypeScript）とバックエンド（FastAPI + Python）の両方に対応した統一的な規約を定めています。

> 📚 **関連ドキュメント**: [開発ルール.md](開発ルール.md) を参照

---

## 1. 命名規則

### 1-1. 変数・関数・クラス名

#### **camelCase**: 変数、関数、メソッド名
```typescript
// フロントエンド
const userName = "田中太郎";
const getUserProfile = () => {};
const isUserActive = true;

// バックエンド
user_name = "田中太郎"
def get_user_profile(): pass
is_user_active = True
```

#### **PascalCase**: クラス、コンポーネント、型定義
```typescript
// フロントエンド
class UserProfile {}
interface UserData {}
const UserProfileComponent = () => {};
type UserStatus = "active" | "inactive";

// バックエンド
class UserProfile: pass
class UserData: pass
```

#### **SCREAMING_SNAKE_CASE**: 定数
```typescript
// フロントエンド
const API_BASE_URL = "https://api.bridge-line.com";
const MAX_RETRY_COUNT = 3;
const DEFAULT_TIMEOUT = 5000;

// バックエンド
API_BASE_URL = "https://api.bridge-line.com"
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 5000
```

### 1-2. ファイル・ディレクトリ名

#### **kebab-case**: ファイル名、ディレクトリ名
```
user-profile.tsx
voice-chat-session.ts
user-profile.component.tsx
api/
components/
voice-chat/
```

### 1-3. データベース関連

#### **snake_case**: テーブル名、カラム名
```sql
user_profiles
voice_chat_sessions
created_at
updated_at
team_id
user_id
```

---

## 2. コメント記述ルール

### 2-1. 関数・メソッドのコメント

#### **フロントエンド（JSDoc形式）**
```typescript
/**
 * ユーザープロフィールを取得する
 * @param userId - ユーザーID
 * @param includeTeam - チーム情報を含めるかどうか
 * @returns Promise<UserProfile> - ユーザープロフィール情報
 * @throws {Error} - API通信エラー時
 * @example
 * ```typescript
 * const profile = await getUserProfile("user123", true);
 * console.log(profile.name);
 * ```
 */
const getUserProfile = async (
  userId: string, 
  includeTeam: boolean = false
): Promise<UserProfile> => {
  // 実装
};
```

#### **バックエンド（Python docstring形式）**
```python
def get_user_profile(user_id: str, include_team: bool = False) -> UserProfile:
    """
    ユーザープロフィールを取得する
    
    Args:
        user_id (str): ユーザーID
        include_team (bool, optional): チーム情報を含めるかどうか. Defaults to False.
        
    Returns:
        UserProfile: ユーザープロフィール情報
        
    Raises:
        HTTPException: ユーザーが見つからない場合
        ValidationError: 入力値が不正な場合
        
    Example:
        >>> profile = get_user_profile("user123", True)
        >>> print(profile.name)
    """
    pass
```

### 2-2. 複雑なロジックのコメント

```typescript
// 音声データの前処理
// 1. ノイズ除去（バンドパスフィルタ適用）
// 2. 音量正規化（RMS値で0.8に調整）
// 3. フォーマット変換（44.1kHz, 16bit, モノラル）
const preprocessAudio = (audioData: AudioBuffer) => {
  // 実装
};

// 複雑な条件分岐の説明
if (user.role === 'admin' && user.teamId === currentTeamId) {
  // 管理者かつ現在のチームメンバーの場合のみ実行
  // セキュリティ上、権限チェックを厳密に行う
}
```

### 2-3. TODO・FIXMEコメント

```typescript
// TODO: 2024年3月までにWebSocket接続の安定性を向上させる
// FIXME: メモリリークの可能性があるため、イベントリスナーの削除を確認
// NOTE: この処理はパフォーマンスに影響するため、キャッシュを検討
```

---

## 3. エラーハンドリング

### 3-1. フロントエンド

#### **API呼び出し時のエラーハンドリング**
```typescript
// API呼び出し時のエラーハンドリング
const fetchUserData = async (userId: string) => {
  try {
    const response = await api.get(`/users/${userId}`);
    return response.data;
  } catch (error) {
    if (error.response?.status === 404) {
      throw new Error('ユーザーが見つかりません');
    } else if (error.response?.status === 403) {
      throw new Error('アクセス権限がありません');
    } else if (error.response?.status >= 500) {
      throw new Error('サーバーエラーが発生しました。しばらく時間をおいて再試行してください。');
    } else {
      throw new Error('データの取得に失敗しました');
    }
  }
};
```

#### **コンポーネントでのエラー表示**
```typescript
const UserProfile = () => {
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  
  const handleError = (error: Error) => {
    setError(error.message);
    toast.error(error.message);
    // エラーログの送信
    logger.error('UserProfile error', { error: error.message });
  };
  
  const handleRetry = () => {
    setError(null);
    // 再試行ロジック
  };
  
  return (
    <div>
      {error && (
        <div className="error-message">
          <p>{error}</p>
          <button onClick={handleRetry}>再試行</button>
        </div>
      )}
      {/* コンポーネント内容 */}
    </div>
  );
};
```

### 3-2. バックエンド

#### **カスタム例外の定義**
```python
# カスタム例外の定義
class UserNotFoundError(Exception):
    """ユーザーが見つからない場合の例外"""
    pass

class InsufficientPermissionError(Exception):
    """権限不足の場合の例外"""
    pass

class ValidationError(Exception):
    """入力値検証エラーの例外"""
    pass
```

#### **エラーハンドリング**
```python
async def get_user_profile(user_id: str) -> UserProfile:
    try:
        # 入力値検証
        if not user_id or not isinstance(user_id, str):
            raise ValidationError("Invalid user ID")
            
        user = await user_repository.get_by_id(user_id)
        if not user:
            raise UserNotFoundError(f"User {user_id} not found")
            
        return user
        
    except UserNotFoundError:
        logger.warning(f"User not found: {user_id}")
        raise HTTPException(status_code=404, detail="ユーザーが見つかりません")
    except ValidationError as e:
        logger.warning(f"Validation error: {e}")
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"Unexpected error in get_user_profile: {e}")
        raise HTTPException(status_code=500, detail="内部サーバーエラー")
```

---

## 4. セキュリティコーディング規約

### 4-1. 入力値検証

#### **フロントエンド - Zodを使用したバリデーション**
```typescript
import { z } from 'zod';

const userSchema = z.object({
  name: z.string()
    .min(1, '名前は必須です')
    .max(100, '名前は100文字以内で入力してください')
    .regex(/^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s]+$/, '名前は英数字、ひらがな、カタカナ、漢字のみ使用可能です'),
  email: z.string()
    .email('有効なメールアドレスを入力してください')
    .max(255, 'メールアドレスは255文字以内で入力してください'),
  age: z.number()
    .min(0, '年齢は0以上で入力してください')
    .max(150, '年齢は150以下で入力してください'),
});

const validateUserInput = (data: unknown) => {
  try {
    return userSchema.parse(data);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const messages = error.errors.map(e => e.message);
      throw new Error(`入力値が不正です: ${messages.join(', ')}`);
    }
    throw new Error('入力値が不正です');
  }
};
```

#### **バックエンド - Pydanticを使用したバリデーション**
```python
from pydantic import BaseModel, validator, EmailStr
import re

class UserCreateRequest(BaseModel):
    name: str
    email: EmailStr
    age: int
    
    @validator('name')
    def validate_name(cls, v):
        if not v or len(v) > 100:
            raise ValueError('名前は1-100文字で入力してください')
        if not re.match(r'^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s]+$', v):
            raise ValueError('名前は英数字、ひらがな、カタカナ、漢字のみ使用可能です')
        return v.strip()
    
    @validator('age')
    def validate_age(cls, v):
        if v < 0 or v > 150:
            raise ValueError('年齢は0-150の範囲で入力してください')
        return v
```

### 4-2. SQLインジェクション対策

```python
# パラメータ化クエリの使用
async def get_user_by_email(email: str) -> Optional[User]:
    query = text("SELECT * FROM users WHERE email = :email")
    result = await database.fetch_one(query, {"email": email})
    return result

# 動的クエリの安全な構築
async def search_users(search_term: str, limit: int = 10) -> List[User]:
    # 検索語のサニタイズ
    safe_search_term = re.sub(r'[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]', '', search_term)
    
    query = text("""
        SELECT * FROM users 
        WHERE name ILIKE :search_term 
        ORDER BY created_at DESC 
        LIMIT :limit
    """)
    result = await database.fetch_all(query, {
        "search_term": f"%{safe_search_term}%",
        "limit": limit
    })
    return result
```

### 4-3. XSS対策

```typescript
// フロントエンド - 危険なHTMLのサニタイズ
import DOMPurify from 'dompurify';

const sanitizeHtml = (html: string) => {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'p', 'br'],
    ALLOWED_ATTR: []
  });
};

// React - dangerouslySetInnerHTMLの使用を避ける
const UserMessage = ({ message }: { message: string }) => {
  // 自動的にエスケープされる
  return <div>{message}</div>;
};

// やむを得ずHTMLを表示する場合
const UserMessageWithHtml = ({ message }: { message: string }) => {
  const sanitizedMessage = sanitizeHtml(message);
  return <div dangerouslySetInnerHTML={{ __html: sanitizedMessage }} />;
};
```

### 4-4. CSRF対策

```typescript
// フロントエンド - CSRFトークンの送信
const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  headers: {
    'X-CSRF-Token': getCsrfToken(),
  },
});
```

---

## 5. パフォーマンス最適化

### 5-1. フロントエンド

#### **React.memoの使用**
```typescript
// 不要な再レンダリングを防ぐ
const UserProfile = React.memo(({ user }: { user: User }) => {
  return (
    <div>
      <h3>{user.name}</h3>
      <p>{user.email}</p>
    </div>
  );
});

// カスタム比較関数を使用
const UserList = React.memo(({ users }: { users: User[] }) => {
  return (
    <ul>
      {users.map(user => (
        <UserProfile key={user.id} user={user} />
      ))}
    </ul>
  );
}, (prevProps, nextProps) => {
  return prevProps.users.length === nextProps.users.length &&
         prevProps.users.every((user, index) => 
           user.id === nextProps.users[index]?.id
         );
});
```

#### **useMemoの使用**
```typescript
const UserDashboard = ({ users, filters }: { users: User[], filters: FilterState }) => {
  // 重い計算をメモ化
  const filteredUsers = useMemo(() => {
    return users.filter(user => {
      if (filters.role && user.role !== filters.role) return false;
      if (filters.teamId && user.teamId !== filters.teamId) return false;
      return true;
    });
  }, [users, filters]);

  // ソート処理もメモ化
  const sortedUsers = useMemo(() => {
    return [...filteredUsers].sort((a, b) => 
      a.name.localeCompare(b.name, 'ja')
    );
  }, [filteredUsers]);

  return (
    <div>
      {sortedUsers.map(user => (
        <UserCard key={user.id} user={user} />
      ))}
    </div>
  );
};
```

#### **useCallbackの使用**
```typescript
const UserList = ({ users, onUserSelect }: { users: User[], onUserSelect: (user: User) => void }) => {
  // コールバック関数をメモ化
  const handleUserClick = useCallback((user: User) => {
    onUserSelect(user);
  }, [onUserSelect]);

  return (
    <div>
      {users.map(user => (
        <UserCard 
          key={user.id} 
          user={user} 
          onClick={() => handleUserClick(user)}
        />
      ))}
    </div>
  );
};
```

### 5-2. バックエンド

#### **データベースクエリの最適化**
```python
# N+1問題を避けるため、JOINを使用
async def get_users_with_teams():
    query = """
    SELECT 
        u.id, u.name, u.email, u.created_at,
        t.id as team_id, t.name as team_name
    FROM users u 
    LEFT JOIN teams t ON u.team_id = t.id
    ORDER BY u.created_at DESC
    """
    return await database.fetch_all(query)

# ページネーションの実装
async def get_users_paginated(page: int = 1, page_size: int = 20):
    offset = (page - 1) * page_size
    query = """
    SELECT * FROM users 
    ORDER BY created_at DESC 
    LIMIT :limit OFFSET :offset
    """
    return await database.fetch_all(query, {
        "limit": page_size,
        "offset": offset
    })
```

#### **キャッシュの使用**
```python
from functools import lru_cache
import redis
from typing import Optional

# メモリキャッシュ
@lru_cache(maxsize=128)
def get_user_permissions(user_id: str):
    """権限情報のキャッシュ（メモリ）"""
    # 権限情報の取得ロジック
    pass

# Redisキャッシュ
async def get_user_profile_cached(user_id: str) -> Optional[UserProfile]:
    """ユーザープロフィールのキャッシュ（Redis）"""
    cache_key = f"user_profile:{user_id}"
    
    # キャッシュから取得を試行
    cached_data = await redis_client.get(cache_key)
    if cached_data:
        return UserProfile.parse_raw(cached_data)
    
    # データベースから取得
    user_profile = await get_user_profile(user_id)
    if user_profile:
        # キャッシュに保存（5分間）
        await redis_client.setex(
            cache_key, 
            300, 
            user_profile.json()
        )
    
    return user_profile
```

---

## 6. コード品質チェック

### 6-1. 実装前チェックリスト

- [ ] 型定義の確認
- [ ] API仕様の確認
- [ ] データベース設計の確認
- [ ] セキュリティ要件の確認
- [ ] パフォーマンス要件の確認

### 6-2. 実装中チェックリスト

- [ ] 型エラーの解消
- [ ] Lintingエラーの解消
- [ ] テストの作成・実行
- [ ] ドキュメントの更新
- [ ] エラーハンドリングの実装

### 6-3. 実装後チェックリスト

- [ ] 全テストの通過
- [ ] 型チェックの通過
- [ ] コードレビューの完了
- [ ] セキュリティチェックの完了
- [ ] パフォーマンステストの完了

---

## 7. ツール設定

### 7-1. フロントエンド

#### **ESLint設定**
```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "prefer-const": "error"
  }
}
```

#### **Prettier設定**
```javascript
module.exports = {
  printWidth: 80,
  tabWidth: 2,
  useTabs: false,
  semi: true,
  singleQuote: true,
  trailingComma: 'es5',
  endOfLine: 'lf',
};
```

### 7-2. バックエンド

#### **Black設定**
```toml
[tool.black]
line-length = 88
target-version = ['py39', 'py310', 'py311', 'py312']
```

#### **isort設定**
```toml
[tool.isort]
profile = "black"
line_length = 88
multi_line_output = 3
```

#### **MyPy設定**
```toml
[tool.mypy]
python_version = "3.9"
strict = true
warn_return_any = true
warn_unused_configs = true
```

---

## 8. 参考資料

- [TypeScript公式ドキュメント](https://www.typescriptlang.org/docs/)
- [React公式ドキュメント](https://react.dev/)
- [FastAPI公式ドキュメント](https://fastapi.tiangolo.com/)
- [Python公式ドキュメント](https://docs.python.org/3/)
- [OWASPセキュリティガイドライン](https://owasp.org/)

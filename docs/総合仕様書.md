## プロジェクト概要

Bridge LINEは、BtoB向けチームコミュニケーションアプリケーションです。チーム単位での音声チャット、リアルタイム文字起こし、AI分析による個人特性フィードバックを提供し、チーム責任者による一元的な管理・決済機能を備えています。

### アプリケーションの特徴

- **BtoB特化**: 企業・組織のチーム単位での導入を想定
- **音声コミュニケーション**: 音声のみでのチャット機能に特化
- **AI分析フィードバック**: 話者別の発言特性を分析し、個人の成長をサポート
- **チーム責任者管理**: 責任者による決済・メンバー管理の一元化

## 開発体制・制約

- **開発チーム**: 3人（全員初学者）
- **開発期間**: 70時間（5時間/日 × 14日）
- **技術習得**: 実装と並行して学習
- **開発ゴール**: 本番環境へのデプロイ完了
- **品質保証**: フロント/バック/E2Eテスト必須実施

## 技術スタック

### フロントエンド

- **フレームワーク**: Next.js 14.0.0 (App Router)
- **言語**: TypeScript 5.0+
- **UIライブラリ**: Material-UI (MUI) v5.14.0
- **状態管理**: React Hook (useState, useEffect, useContext)
- **認証**: Firebase Authentication
- **決済**: Stripe (@stripe/stripe-js, @stripe/react-stripe-js)
- **リアルタイム通信**: Socket.io-client 4.7.0
- **音声処理**: WebRTC (simple-peer 9.11.1)

### バックエンド

- **フレームワーク**: FastAPI 0.104.0
- **言語**: Python 3.11+
- **ORM**: SQLAlchemy 2.0.0
- **データベース**: PostgreSQL 15
- **認証**: Firebase Admin SDK
- **決済**: Stripe Python SDK
- **音声処理**: OpenAI Whisper API, pydub
- **AI分析**: OpenAI GPT-4o API
- **リアルタイム通信**: python-socketio 5.10.0

### インフラ・デプロイメント

- **コンテナ**: Docker + Docker Compose
- **クラウド**: Vercel (フロント) + Railway (バック + DB)
- **CI/CD**: GitHub Actions
- **監視**: 基本ログ + エラートラッキング
- **セキュリティ**: HTTPS, CORS, 環境変数管理

## ページ遷移・画面構成

```
Firebase認証ログイン
　↓
ダッシュボード
　├── 音声チャットルーム
　│   ├── ログイン中メンバー表示
　│   ├── 音声チャット機能
　│   └── リアルタイム文字起こし表示
　├── チームメンバー管理（責任者のみ）
　│   ├── メンバー一覧・招待
　│   ├── 各メンバーのプロフィール詳細
　│   └── メンバー権限管理
　├── マイプロフィール
　│   ├── プロフィール編集
　│   └── AI分析フィードバック一覧
　└── チーム管理（責任者のみ）
　　　├── 決済・プラン管理
　　　├── 使用量確認
　　　└── チーム設定

```

## コア機能

| 機能名 | 説明 | 対象ユーザー |
| --- | --- | --- |
| ユーザー認証 | Firebase Authentication + ロール管理 | 全ユーザー |
| 音声チャットルーム | WebRTC音声通話・リアルタイム文字起こし | 全ユーザー |
| AI分析・フィードバック | 発言特性分析・個人特性フィードバック | 全ユーザー |
| チーム管理 | メンバー招待・権限管理 | 責任者のみ |
| 決済・プラン管理 | Stripeサブスクリプション決済 | 責任者のみ |
| プロフィール管理 | 個人情報・AI分析結果閲覧 | 全ユーザー |

## データベース設計

### ER図

```mermaid
erDiagram
    users {
        UUID id PK
        VARCHAR firebase_uid UK
        VARCHAR email UK
        VARCHAR display_name
        VARCHAR avatar_url
        BOOLEAN is_online
        TIMESTAMP last_seen_at
        VARCHAR account_status
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    teams {
        UUID id PK
        VARCHAR name
        TEXT description
        VARCHAR team_code UK
        UUID created_by FK "責任者"
        INTEGER max_members
        BOOLEAN is_active
        JSONB settings
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    team_memberships {
        UUID id PK
        UUID team_id FK
        UUID user_id FK
        VARCHAR role "owner/admin/member"
        VARCHAR status "active/inactive/invited"
        TIMESTAMP joined_at
        TIMESTAMP left_at
    }

    user_profiles {
        UUID id PK
        UUID user_id FK
        TEXT bio
        VARCHAR department
        VARCHAR position
        JSONB interests
        VARCHAR communication_style
        DECIMAL collaboration_score
        DECIMAL leadership_score
        DECIMAL empathy_score
        DECIMAL assertiveness_score
        DECIMAL creativity_score
        DECIMAL analytical_score
        JSONB visibility_settings
        INTEGER total_chat_sessions
        INTEGER total_speaking_time_seconds
        TIMESTAMP last_analysis_at
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    voice_chat_sessions {
        UUID id PK
        UUID team_id FK
        VARCHAR title
        TEXT description
        VARCHAR status "waiting/active/ended/cancelled"
        INTEGER max_participants
        UUID started_by FK
        TIMESTAMP started_at
        TIMESTAMP ended_at
        INTEGER duration_seconds
        BOOLEAN auto_transcription
        INTEGER total_messages
        INTEGER total_speaking_time_seconds
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    voice_messages {
        UUID id PK
        UUID session_id FK
        UUID speaker_id FK
        TEXT transcribed_text
        DECIMAL confidence_score
        DECIMAL audio_duration_seconds
        INTEGER session_timestamp_start
        INTEGER session_timestamp_end
        VARCHAR transcription_method
        VARCHAR message_type
        VARCHAR detected_emotion
        TIMESTAMP created_at
    }

    speaker_analyses {
        UUID id PK
        UUID session_id FK
        UUID speaker_id FK
        VARCHAR analysis_type
        INTEGER analyzed_message_count
        INTEGER analyzed_speaking_time_seconds
        DECIMAL participation_level
        DECIMAL speaking_ratio
        DECIMAL empathy_expression
        DECIMAL collaboration_facilitation
        DECIMAL logical_structure
        DECIMAL creative_ideas
        JSONB communication_strengths
        JSONB improvement_areas
        VARCHAR analysis_model
        DECIMAL confidence_level
        TIMESTAMP created_at
    }

    feedback_messages {
        UUID id PK
        UUID recipient_id FK
        UUID analysis_id FK
        UUID session_id FK
        VARCHAR feedback_type
        VARCHAR title
        TEXT summary
        TEXT detailed_content
        VARCHAR primary_category
        VARCHAR priority_level
        JSONB highlighted_strengths
        JSONB improvement_suggestions
        VARCHAR delivery_status
        BOOLEAN is_favorite
        INTEGER user_rating
        TIMESTAMP created_at
    }

    subscription_plans {
        UUID id PK
        VARCHAR name "free/premium/enterprise"
        VARCHAR display_name
        TEXT description
        DECIMAL price_monthly
        DECIMAL price_yearly
        INTEGER max_team_members
        INTEGER max_monthly_sessions
        INTEGER ai_analysis_limit
        JSONB features
        VARCHAR stripe_price_id_monthly
        VARCHAR stripe_price_id_yearly
        BOOLEAN is_active
        TIMESTAMP created_at
    }

    team_subscriptions {
        UUID id PK
        UUID team_id FK
        UUID plan_id FK
        UUID subscribed_by FK "責任者"
        VARCHAR stripe_customer_id
        VARCHAR stripe_subscription_id
        VARCHAR status "active/canceled/past_due"
        VARCHAR billing_cycle "monthly/yearly"
        TIMESTAMP current_period_start
        TIMESTAMP current_period_end
        BOOLEAN cancel_at_period_end
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    payment_transactions {
        UUID id PK
        UUID team_id FK
        UUID subscription_id FK
        VARCHAR stripe_payment_intent_id
        DECIMAL amount
        VARCHAR currency
        VARCHAR status
        VARCHAR transaction_type
        TEXT description
        TIMESTAMP processed_at
        TIMESTAMP created_at
    }

    usage_tracking {
        UUID id PK
        UUID team_id FK
        DATE tracking_month
        INTEGER sessions_count
        INTEGER ai_analyses_count
        INTEGER total_speaking_time_seconds
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    %% リレーションシップ
    users ||--o{ teams : "created_by(責任者)"
    users ||--o{ team_memberships : "user_id"
    teams ||--o{ team_memberships : "team_id"
    users ||--|| user_profiles : "user_id"
    teams ||--o{ voice_chat_sessions : "team_id"
    users ||--o{ voice_chat_sessions : "started_by"
    voice_chat_sessions ||--o{ voice_messages : "session_id"
    users ||--o{ voice_messages : "speaker_id"
    voice_chat_sessions ||--o{ speaker_analyses : "session_id"
    users ||--o{ speaker_analyses : "speaker_id"
    users ||--o{ feedback_messages : "recipient_id"
    speaker_analyses ||--o{ feedback_messages : "analysis_id"
    teams ||--|| team_subscriptions : "team_id"
    users ||--o{ team_subscriptions : "subscribed_by(責任者)"
    subscription_plans ||--o{ team_subscriptions : "plan_id"
    team_subscriptions ||--o{ payment_transactions : "subscription_id"
    teams ||--o{ usage_tracking : "team_id"

```

### 主要テーブル説明

### 1. チーム・権限管理

- **teams**: チーム基本情報（責任者が作成・管理）
- **team_memberships**: ユーザーとチームの関係（role: owner/admin/member）
- **users**: ユーザー基本情報（Firebase認証連携）

### 2. 音声チャット・分析

- **voice_chat_sessions**: 音声チャットセッション
- **voice_messages**: 話者別音声メッセージ・文字起こし
- **speaker_analyses**: AI分析結果
- **feedback_messages**: 個人特性フィードバック

### 3. 決済・使用量管理

- **subscription_plans**: サブスクリプションプラン
- **team_subscriptions**: チーム単位のサブスクリプション
- **payment_transactions**: 決済履歴
- **usage_tracking**: 月別使用量追跡

## API設計

### 認証・権限管理

### POST /auth/login

Firebase IDトークンでログイン・ロール情報取得

**リクエスト**:

```json
{
  "firebase_id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI...",
  "device_info": {
    "platform": "web",
    "browser": "Chrome"
  }
}

```

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user123",
      "firebase_uid": "firebase_123",
      "email": "admin@company.com",
      "display_name": "田中太郎",
      "avatar_url": "<https://example.com/avatar.jpg>"
    },
    "team_roles": [
      {
        "team_id": "team123",
        "team_name": "開発チーム",
        "role": "owner"
      }
    ],
    "session_token": "session_token_123"
  }
}

```

### チーム管理（責任者のみ）

### GET /teams/{team_id}/members

チームメンバー一覧取得

**認可**: チーム責任者・管理者のみ

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "team": {
      "id": "team123",
      "name": "開発チーム",
      "member_count": 8,
      "subscription_plan": "premium",
      "usage_this_month": {
        "sessions_count": 15,
        "ai_analyses_count": 120,
        "limit_sessions": 50,
        "limit_analyses": 500
      }
    },
    "members": [
      {
        "id": "user123",
        "display_name": "田中太郎",
        "email": "tanaka@company.com",
        "role": "owner",
        "status": "active",
        "joined_at": "2024-01-01T00:00:00Z",
        "last_active": "2024-01-15T10:30:00Z"
      }
    ]
  }
}

```

### POST /teams/{team_id}/invite

チームメンバー招待

**認可**: チーム責任者・管理者のみ

**リクエスト**:

```json
{
  "email": "new_member@company.com",
  "role": "member",
  "display_name": "山田花子"
}

```

### 決済管理（責任者のみ）

### GET /teams/{team_id}/subscription

チームのサブスクリプション情報取得

**認可**: チーム責任者のみ

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "subscription": {
      "id": "sub123",
      "plan": {
        "name": "premium",
        "display_name": "プレミアムプラン",
        "price_monthly": 980,
        "max_team_members": 10,
        "max_monthly_sessions": 50,
        "ai_analysis_limit": 500,
        "features": ["高度AI分析", "詳細フィードバック", "チーム分析レポート"]
      },
      "status": "active",
      "billing_cycle": "monthly",
      "current_period_start": "2024-01-01T00:00:00Z",
      "current_period_end": "2024-02-01T00:00:00Z",
      "cancel_at_period_end": false
    },
    "usage_current_month": {
      "sessions_count": 15,
      "ai_analyses_count": 120,
      "total_speaking_time_hours": 25.5
    },
    "next_payment": {
      "amount": 980,
      "currency": "JPY",
      "due_date": "2024-02-01T00:00:00Z"
    }
  }
}

```

### POST /teams/{team_id}/subscribe

新規サブスクリプション開始

**認可**: チーム責任者のみ

**リクエスト**:

```json
{
  "plan_id": "plan123",
  "billing_cycle": "monthly",
  "payment_method": "stripe"
}

```

### GET /subscription/plans

利用可能なサブスクリプションプラン一覧

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "plans": [
      {
        "id": "plan1",
        "name": "free",
        "display_name": "フリープラン",
        "description": "基本機能を無料で利用",
        "price_monthly": 0,
        "price_yearly": 0,
        "max_team_members": 3,
        "max_monthly_sessions": 5,
        "ai_analysis_limit": 20,
        "features": ["基本音声チャット", "簡易分析レポート"],
        "is_popular": false
      },
      {
        "id": "plan2",
        "name": "premium",
        "display_name": "プレミアムプラン",
        "description": "チーム利用に最適",
        "price_monthly": 980,
        "price_yearly": 9800,
        "max_team_members": 10,
        "max_monthly_sessions": 50,
        "ai_analysis_limit": 500,
        "features": ["高度AI分析", "詳細フィードバック", "チーム分析レポート", "データエクスポート"],
        "is_popular": true
      },
      {
        "id": "plan3",
        "name": "enterprise",
        "display_name": "エンタープライズプラン",
        "description": "大規模チーム向け",
        "price_monthly": 2980,
        "price_yearly": 29800,
        "max_team_members": 50,
        "max_monthly_sessions": 200,
        "ai_analysis_limit": 2000,
        "features": ["無制限AI分析", "カスタム分析", "API アクセス", "専用サポート"],
        "is_popular": false
      }
    ]
  }
}

```

### 音声チャット機能

### POST /teams/{team_id}/voice-sessions

音声チャットセッション開始

**リクエスト**:

```json
{
  "title": "週次定例ミーティング",
  "description": "今週の進捗と来週の計画について",
  "max_participants": 8,
  "auto_transcription": true
}

```

### POST /voice-sessions/{session_id}/messages

音声メッセージ送信・文字起こし

**リクエスト** (multipart/form-data):

```
audio_file: (file) 音声ファイル
session_timestamp_start: (integer) 開始タイムスタンプ（ミリ秒）
session_timestamp_end: (integer) 終了タイムスタンプ（ミリ秒）

```

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "message": {
      "id": "message123",
      "session_id": "session123",
      "speaker": {
        "id": "user123",
        "display_name": "田中太郎"
      },
      "transcribed_text": "今週のプロジェクト進捗について報告します。フロントエンドの実装が順調に進んでいます。",
      "confidence_score": 0.9240,
      "audio_duration_seconds": 8.5,
      "detected_emotion": "neutral",
      "created_at": "2024-01-15T10:02:00Z"
    }
  }
}

```

### AI分析・フィードバック

### POST /voice-sessions/{session_id}/analyze

セッション終了後のAI分析実行

**リクエスト**:

```json
{
  "analysis_type": "comprehensive",
  "generate_feedback": true,
  "update_user_profiles": true
}

```

### GET /profile/me/feedback

自分のフィードバック一覧取得

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "feedback": [
      {
        "id": "feedback123",
        "title": "コミュニケーション特性分析結果",
        "summary": "協調性が高く、チームワークを重視したコミュニケーションスタイルです",
        "primary_category": "communication",
        "priority_level": "high",
        "delivery_status": "delivered",
        "is_favorite": false,
        "created_at": "2024-01-15T10:30:00Z",
        "source_session": {
          "id": "session123",
          "title": "週次定例ミーティング",
          "date": "2024-01-15T10:00:00Z"
        }
      }
    ],
    "summary": {
      "total_count": 12,
      "unread_count": 3,
      "high_priority_count": 1
    }
  }
}

```

## セキュリティ仕様

### 認証・認可

- **Firebase Authentication**: メール/パスワード認証
- **JWT Token**: APIアクセス制御
- **Role-Based Access Control**: owner/admin/member権限管理
- **Team-Based Authorization**: チーム単位でのリソースアクセス制御

### データ保護

- **HTTPS通信**: 全通信の暗号化
- **個人情報暗号化**: 機密データのDB暗号化保存
- **音声ファイル**: 一時保存・処理後自動削除
- **CORS設定**: 許可ドメインのみAPIアクセス可能

### 決済セキュリティ

- **PCI DSS準拠**: Stripe決済による安全な決済処理
- **Webhook署名検証**: Stripe Webhookの正当性検証
- **API Key管理**: 環境変数による機密情報管理

### 入力検証・サニタイゼーション

- **バックエンド**: Pydantic によるデータ検証
- **フロントエンド**: TypeScript型チェック + バリデーション
- **SQLインジェクション対策**: SQLAlchemy ORM使用
- **XSS対策**: 入力値サニタイゼーション

## テスト仕様

### フロントエンドテスト

```tsx
// テストフレームワーク
- Jest + React Testing Library
- MSW (Mock Service Worker) - API モック
- Cypress - E2Eテスト

// テスト対象
- コンポーネントユニットテスト
- フックテスト
- 統合テスト（API連携）
- E2Eテスト（主要フロー）

```

### バックエンドテスト

```python
# テストフレームワーク
- pytest
- pytest-asyncio
- httpx (テストクライアント)
- pytest-mock

# テスト対象
- APIエンドポイントテスト
- サービス層ユニットテスト
- データベース統合テスト
- 外部API連携テスト（モック使用）

```

### E2Eテスト

```tsx
// Cypressを使用したE2Eテスト
- ユーザー認証フロー
- チーム作成・メンバー招待
- 音声チャットセッション（モック音声使用）
- 決済フロー（Stripeテストモード）
- AI分析・フィードバック確認

```

## CI/CD仕様（GitHub Actions）

### ワークフロー構成

### .github/workflows/ci.yml

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # フロントエンドテスト
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Run type check
        run: cd frontend && npm run type-check

      - name: Run unit tests
        run: cd frontend && npm run test -- --coverage

      - name: Run build
        run: cd frontend && npm run build

  # バックエンドテスト
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bridge_line_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bridge_line_test
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_TEST }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY_TEST }}
        run: cd backend && pytest --cov=app tests/

  # E2Eテスト
  e2e-test:
    runs-on: ubuntu-latest
    needs: [frontend-test, backend-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Build application
        run: cd frontend && npm run build

      - name: Run E2E tests
        run: cd frontend && npm run cypress:run
        env:
          CYPRESS_BASE_URL: <http://localhost:3000>
          CYPRESS_API_URL: <http://localhost:8000>

  # デプロイ（mainブランチのみ）
  deploy:
    runs-on: ubuntu-latest
    needs: [frontend-test, backend-test, e2e-test]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      # フロントエンドデプロイ（Vercel）
      - name: Deploy Frontend to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend

      # バックエンドデプロイ（Railway）
      - name: Deploy Backend to Railway
        uses: bervProject/railway-deploy@v1.0.0
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}

```

### デプロイ環境

### フロントエンド（Vercel）

```bash
# 環境変数
NEXT_PUBLIC_API_URL=https://bridge-line-api.railway.app
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
NEXT_PUBLIC_FIREBASE_CONFIG={"apiKey":"..."}

```

### バックエンド（Railway）

```bash
# 環境変数
DATABASE_URL=postgresql://user:pass@host:port/db
OPENAI_API_KEY=sk-...
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
FIREBASE_PROJECT_ID=bridge-line-prod
CORS_ORIGINS=["<https://bridge-line.vercel.app>"]

```

## 開発スケジュール

### Phase 1: 認証・基本機能（Day 1-4, 20時間）

- Firebase認証実装
- ユーザー・チーム管理
- 基本UI構築
- データベースセットアップ

### Phase 2: 音声チャット機能（Day 5-8, 20時間）

- WebRTC音声通話実装
- リアルタイム文字起こし
- セッション管理機能

### Phase 3: AI分析・フィードバック（Day 9-11, 15時間）

- OpenAI API連携
- 分析結果保存・表示
- フィードバック機能

### Phase 4: 決済・権限管理（Day 12-13, 10時間）

- Stripe決済機能
- 責任者権限管理
- 使用量制限機能

### Phase 5: テスト・デプロイ（Day 14, 5時間）

- 各種テスト実行
- CI/CD設定
- 本番デプロイ

## 運用・監視

### ログ管理

- **アプリケーションログ**: 構造化ログ出力
- **エラートラッキング**: 基本的なエラー監視
- **アクセスログ**: API呼び出し記録
- **決済ログ**: Stripe Webhook イベント記録

### パフォーマンス監視

- **レスポンス時間**: API応答速度監視
- **データベース**: クエリパフォーマンス
- **リアルタイム通信**: WebSocket接続状態
- **外部API**: OpenAI・Stripe API応答監視

### セキュリティ監視

- **認証失敗**: 不正ログイン試行検知
- **API利用量**: レート制限・異常アクセス検知
- **データベース**: 異常クエリ検知

この仕様書に基づき、Bridge LINEの開発から本番デプロイまでを包括的に実行できます。初学者チームでも段階的に学習しながら、企業向けの堅牢なアプリケーションを構築することが可能です。
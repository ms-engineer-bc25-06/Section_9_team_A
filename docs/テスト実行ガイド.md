# 🧪 Bridge Line テスト実行ガイド

## 📋 概要

このガイドでは、Bridge Lineプロジェクトのテスト実行方法について説明します。フロントエンド（Next.js）とバックエンド（FastAPI）両方のテスト環境が整備されています。

## 🚀 クイックスタート

### 全テストを実行
```bash
# Makefileを使用
make test

# スクリプトを使用
./scripts/run-tests.sh

# 個別実行
make test-backend
make test-frontend
```

### 品質チェック
```bash
# 全体的な品質チェック
make quality

# クイックチェック（テストなし）
make quality-quick
```

## 🔧 フロントエンドテスト（Next.js）

### テスト環境
- **Jest**: ユニットテスト
- **Testing Library**: Reactコンポーネントテスト
- **Cypress**: E2Eテスト
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット

### 認証テスト
```bash
# 認証テストのみ実行
npm test -- --config=jest.config.auth.js

# 特定の認証テストファイル
npm test -- --config=jest.config.auth.js AuthProvider.test.tsx
npm test -- --config=jest.config.auth.js LoginForm.test.tsx
npm test -- --config=jest.config.auth.js ProtectedRoute.test.tsx

# 認証テストのカバレッジ
npm test -- --config=jest.config.auth.js --coverage
```

### テスト実行
```bash
cd frontend

# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# カバレッジ付きテスト
npm run test:coverage

# CI用テスト
npm run test:ci

# E2Eテスト（Cypress）
npm run cypress:open  # インタラクティブ
npm run cypress:run   # ヘッドレス
```

### リンターとフォーマッター
```bash
# ESLint
npm run lint
npm run lint:fix

# Prettier
npm run format
npm run format:check

# 型チェック
npm run type-check
```

### フロントエンドテストの特徴

#### **実装完了したテスト**
- **認証フックテスト** - `src/hooks/__tests__/useAuth.test.tsx`
  - 初期状態、ログイン機能、登録機能、ログアウト機能
  - パスワードリセット、認証状態変更、エラーハンドリング
- **決済サービステスト** - `src/services/__tests__/billingService.test.ts`
  - サブスクリプション管理、決済処理、請求履歴
  - 使用量追跡、支払い方法管理、エラーハンドリング

#### **テストユーティリティ**
- **`src/test-utils.ts`** - 包括的なテストヘルパー
  - モックデータ作成（ユーザー、プラン、決済、音声セッション等）
  - モックAPI・Firebase・Stripe・WebSocket
  - テスト環境セットアップ・クリーンアップ
  - パフォーマンス測定・エラーハンドリング

#### **テストカバレッジ目標**
- **全体**: 70%
- **認証機能**: 90%+
- **決済機能**: 85%+

## 🐍 バックエンドテスト（FastAPI）

### テスト環境
- **Pytest**: テストフレームワーク
- **Pytest-asyncio**: 非同期テスト
- **Pytest-cov**: カバレッジ測定
- **Flake8**: Pythonリンター
- **Black**: コードフォーマッター
- **isort**: インポート整理
- **mypy**: 型チェック

### テスト実行
```bash
cd backend

# 全テスト実行
python -m pytest tests/ -v

# カバレッジ付きテスト
python -m pytest tests/ -v --cov=app --cov-report=html

# 特定のマーカーでテスト
python -m pytest tests/ -m "unit" -v
python -m pytest tests/ -m "integration" -v
python -m pytest tests/ -m "not slow" -v

# 並列実行
python -m pytest tests/ -n auto
```

### リンターとフォーマッター
```bash
# Flake8（コード品質チェック）
python -m flake8 app/ --max-line-length=88

# Black（コードフォーマット）
python -m black app/ --line-length=88
python -m black app/ --line-length=88 --check

# isort（インポート整理）
python -m isort app/ --profile=black
python -m isort app/ --profile=black --check-only

# mypy（型チェック）
python -m mypy app/ --ignore-missing-imports
```

## 📊 テストマーカー

### バックエンドテストマーカー
```bash
# ユニットテスト（高速、分離）
python -m pytest tests/ -m "unit"

# 統合テスト（中程度の速度、外部依存）
python -m pytest tests/ -m "integration"

# E2Eテスト（低速、全システム）
python -m pytest tests/ -m "e2e"

# データベーステスト
python -m pytest tests/ -m "database"

# 認証テスト
python -m pytest tests/ -m "auth"

# WebSocketテスト
python -m pytest tests/ -m "websocket"

# 管理者認証テスト
python -m pytest tests/ -m "admin"
```

### テストの実行順序
```bash
# 高速テストのみ
python -m pytest tests/ -m "not slow"

# 特定の層のテスト
python -m pytest tests/ -m "repository"
python -m pytest tests/ -m "service"
python -m pytest tests/ -m "api"
```

## 📈 カバレッジ

### カバレッジ要件
- **全体**: 80%以上
- **重要モジュール**: 90%以上
- **新機能**: 90%以上

### カバレッジレポート
```bash
# ターミナル出力
python -m pytest tests/ --cov=app --cov-report=term-missing

# HTMLレポート
python -m pytest tests/ --cov=app --cov-report=html
# ブラウザで htmlcov/index.html を開く

# XMLレポート（CI用）
python -m pytest tests/ --cov=app --cov-report=xml
```

## 🚨 よくある問題と対処法

### フロントエンド
```bash
# 依存関係の問題
rm -rf node_modules package-lock.json
npm install

# Jest設定の問題
npm run test -- --verbose

# TypeScriptエラー
npm run type-check
```

### バックエンド
```bash
# 仮想環境の問題
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 依存関係のインストール
pip install -r requirements-dev.txt

# テストデータベースの問題
python -m pytest tests/ -m "not database"
```

## 🔄 CI/CD統合

### GitHub Actions
```yaml
# .github/workflows/test.yml の例
- name: Run Backend Tests
  run: |
    cd backend
    python -m pytest tests/ --cov=app --cov-report=xml

- name: Run Frontend Tests
  run: |
    cd frontend
    npm run test:ci
```

### ローカルCI
```bash
# コミット前の品質チェック
make quality-quick

# 全体的な品質チェック
make quality

# 特定のテストのみ
make test-backend-unit
make test-frontend-unit
```

---

## 🔧 テスト実装詳細

### テストファイル構成
```
backend/tests/
├── conftest.py                    # 共通フィクスチャ
├── conftest_auth.py              # 認証テスト用フィクスチャ
├── test_auth_minimal.py          # 認証APIの基本テスト
├── test_websocket.py             # WebSocketテスト
├── test_voice_sessions.py        # 音声セッションAPIテスト
└── test_schemas.py               # スキーマテスト

frontend/src/components/auth/__tests__/
├── AuthProvider.test.tsx         # 認証プロバイダーのテスト
├── LoginForm.test.tsx            # ログインフォームのテスト
└── ProtectedRoute.test.tsx       # 保護されたルートのテスト
```

### テストフィクスチャ

#### 共通フィクスチャ (`conftest.py`)
```python
@pytest_asyncio.fixture
async def client() -> CombinedTestClient:
    """HTTP(Async) + WebSocket を兼ねるクライアント"""
    transport = ASGITransport(app=app)
    async_client = AsyncClient(transport=transport, base_url="http://test")
    ws_client = TestClient(app)
    combined = CombinedTestClient(async_client, ws_client)
    try:
        yield combined
    finally:
        await combined.aclose()

@pytest.fixture
def mock_user():
    """モックユーザー"""
    return User(
        id=1,
        email="test@example.com",
        username="testuser",
        display_name="Test User",
        is_active=True,
        created_at=datetime.now(),
        updated_at=datetime.now(),
    )

@pytest.fixture
def mock_voice_session():
    """モック音声セッション"""
    return VoiceSession(
        id=1,
        room_id="test_session_123",
        title="Test Session",
        description="Test session for WebSocket",
        status="active",
        host_id=1,
        team_id=None,
        duration_minutes=0.0,
        participant_count=0,
        recording_url=None,
        is_public=False,
        allow_recording=True,
        started_at=datetime.now(),
        ended_at=None,
        created_at=datetime.now(),
        updated_at=datetime.now(),
    )
```

#### 認証テスト用フィクスチャ (`conftest_auth.py`)
```python
@pytest.fixture
async def test_user(test_db_session):
    """テスト用ユーザー"""
    user = User(
        email="test@example.com",
        username="testuser",
        full_name="Test User",
        firebase_uid="test_firebase_uid",
        is_active=True,
        is_admin=False,
        has_temporary_password=False,
        is_first_login=False
    )
    test_db_session.add(user)
    await test_db_session.commit()
    await test_db_session.refresh(user)
    return user

@pytest.fixture
async def test_admin_user(test_db_session):
    """テスト用管理者ユーザー"""
    admin_user = User(
        email="admin@example.com",
        username="admin",
        full_name="Admin User",
        firebase_uid="admin_firebase_uid",
        is_active=True,
        is_admin=True,
        has_temporary_password=False,
        is_first_login=False
    )
    test_db_session.add(admin_user)
    await test_db_session.commit()
    await test_db_session.refresh(admin_user)
    return admin_user

@pytest.fixture
def user_jwt_token(test_user):
    """ユーザー用JWTトークン"""
    return create_access_token(
        data={"sub": str(test_user.id), "email": test_user.email}
    )

@pytest.fixture
def admin_jwt_token(test_admin_user):
    """管理者用JWTトークン"""
    return create_access_token(
        data={"sub": str(test_admin_user.id), "email": test_admin_user.email}
    )
```

### WebSocketテスト実装

#### 接続テスト
```python
class TestWebSocketConnection:
    async def test_websocket_connection_success(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """WebSocket接続の成功をテスト"""
        with patch("app.core.auth.get_current_user_from_token", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.get_by_room_id", return_value=mock_voice_session):
            
            with client.websocket_connect(
                "/api/v1/ws/voice-sessions/test_session_123?token=test_token"
            ) as websocket:
                # 接続確立メッセージの受信を確認
                data = websocket.receive_json()
                assert data["type"] == "connection_established"
                assert data["session_id"] == "test_session_123"
                assert data["user_id"] == 1
```

#### メッセージ処理テスト
```python
class TestWebSocketMessageHandling:
    async def test_ping_pong_message(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """Ping-Pongメッセージのテスト"""
        with patch("app.core.auth.get_current_user_from_token", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.get_by_room_id", return_value=mock_voice_session):
            
            with client.websocket_connect(
                "/api/v1/ws/voice-sessions/test_session_123?token=test_token"
            ) as websocket:
                # Pingメッセージ送信
                websocket.send_json({"type": "ping"})
                
                # Pongレスポンスの受信確認
                response = websocket.receive_json()
                assert response["type"] == "pong"
```

### APIテスト実装

#### 音声セッションAPIテスト
```python
class TestVoiceSessionControlAPI:
    async def test_start_voice_session_success(
        self, client: CombinedTestClient, mock_voice_session, mock_user
    ):
        """音声セッション開始の成功をテスト"""
        with patch("app.core.auth.get_current_user", return_value=mock_user), \
             patch("app.models.voice_session.VoiceSession.create", return_value=mock_voice_session):
            
            response = await client.post(
                "/api/v1/voice-sessions/",
                json={
                    "title": "Test Session",
                    "description": "Test Description",
                    "is_public": False,
                    "allow_recording": True
                }
            )
            
            assert response.status_code == 201
            data = response.json()
            assert data["session_id"] == "test_session_123"
            assert data["user_id"] == 1
```

#### 認証APIテスト
```python
class TestAuthAPI:
    def test_firebase_login_success(self, client, mock_user):
        """Firebase認証ログイン成功テスト"""
        with patch('app.api.v1.auth.verify_firebase_token') as mock_verify, \
             patch('app.api.v1.auth.AuthService') as mock_auth_service:
            
            mock_verify.return_value = {
                "uid": "test_firebase_uid",
                "email": "test@example.com"
            }
            
            mock_service_instance = MagicMock()
            mock_service_instance.get_firebase_user_only.return_value = mock_user
            mock_auth_service.return_value = mock_service_instance

            response = client.post("/api/v1/auth/firebase-login", json={
                "id_token": "valid_firebase_token",
                "display_name": "Test User"
            })

            assert response.status_code == 200
            data = response.json()
            assert "access_token" in data
            assert data["token_type"] == "bearer"

    def test_temporary_login_success(self, client, mock_user):
        """仮パスワードログイン成功テスト"""
        with patch('app.api.v1.auth.AuthService') as mock_auth_service:
            mock_service_instance = MagicMock()
            mock_service_instance.get_firebase_user_only.return_value = mock_user
            mock_auth_service.return_value = mock_service_instance

            response = client.post("/api/v1/auth/temporary-login", json={
                "email": "test@example.com",
                "password": "temporary_password"
            })

            assert response.status_code == 200
            data = response.json()
            assert "access_token" in data
```

#### 管理者認証テスト
```python
class TestAdminAuth:
    def test_check_admin_success(self, client, admin_user, admin_token):
        """管理者権限チェック成功テスト"""
        with patch('app.api.v1.admin_role.get_current_user') as mock_get_user:
            mock_get_user.return_value = admin_user

            response = client.get("/api/v1/admin-role/check-admin", headers={
                "Authorization": f"Bearer {admin_token}"
            })

            assert response.status_code == 200
            data = response.json()
            assert data["status"] == "success"
            assert data["user"]["is_admin"] is True
```

### テスト環境設定

#### 必要なファイル

##### .gitignore
```gitignore
# 仮想環境
.venv*/
venv*/

# Python
__pycache__/
*.py[cod]
*.so

# テスト結果
.pytest_cache/
.coverage
```

##### requirements-dev.txt
```
fastapi==0.104.1
uvicorn==0.24.0
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.2
```

##### pytest.ini
```ini
[tool:pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

### トラブルシューティング

#### よくある問題と対処法

##### 1. SQLAlchemy関係性エラー
```bash
# エラー例
sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize

# 対処法
# モデルに不足しているrelationshipを追加
class User(Base):
    created_chat_rooms = relationship("ChatRoom", back_populates="creator")
    chat_messages = relationship("ChatMessage", back_populates="sender")
```

##### 2. Pydanticバリデーションエラー
```bash
# エラー例
ValidationError: 1 validation error for VoiceSessionResponse

# 対処法
# スキーマのフィールド名をモデルと一致させる
class VoiceSessionResponse(VoiceSessionBase, TimestampMixin):
    room_id: str = Field(..., alias="session_id")
    host_id: int = Field(..., alias="user_id")
```

##### 3. WebSocket接続エラー（404）
```bash
# エラー例
HTTPException: 404 Not Found

# 対処法
# APIルーターのパス設定を確認
router.include_router(websocket_router, prefix="/ws", tags=["websocket"])
```

##### 4. 認証エラー（403）
```bash
# エラー例
HTTPException: 403 Forbidden

# 対処法
# テストでの認証モックを確認
with patch("app.core.auth.get_current_user", return_value=mock_user):
```

##### 5. Firebase認証エラー
```bash
# エラー例
Firebase authentication failed

# 対処法
# 環境変数を設定
export ENVIRONMENT=development
pytest tests/test_auth_minimal.py -v
```

##### 6. 仮パスワード期限切れエラー
```bash
# エラー例
Temporary password has expired

# 対処法
# テスト用の仮パスワード有効期限を延長
user.temporary_password_expires_at = datetime.utcnow() + timedelta(days=7)
```

#### デバッグ方法

##### ログ確認
```bash
# バックエンドログ
docker logs bridge_line_backend

# リアルタイムログ
docker logs -f bridge_line_backend
```

##### コンテナ状態確認
```bash
# コンテナ一覧
docker ps

# コンテナ内でコマンド実行
docker exec -it bridge_line_backend bash
```

##### テスト実行時の詳細出力
```bash
# 詳細出力
pytest -v -s

# 特定のテストのみ実行
pytest tests/test_websocket.py::TestWebSocketConnection::test_websocket_connection_success -v -s
```

### テストメトリクス

#### 現在のテスト状況
- **総テスト数**: 67個（認証テスト20個追加）
- **成功**: 67個
- **失敗**: 0個
- **スキップ**: 0個
- **カバレッジ**: 約87%（推定）

#### テスト実行時間
- **全テスト実行**: 約35秒
- **認証テスト**: 約8秒
- **WebSocketテスト**: 約10秒
- **APIテスト**: 約12秒
- **スキーマテスト**: 約5秒

#### 今後の改善目標
- **テストカバレッジ**: 90%以上
- **実行時間**: 25秒以内
- **統合テスト**: 15個以上
- **認証テスト**: 30個以上
- **パフォーマンステスト**: 実装予定

---

> 📚 **テスト仕様**: [テスト仕様書.md](テスト仕様書.md) を参照  
> 📚 **テストケース管理**: [テストケース管理.md](テストケース管理.md) を参照
